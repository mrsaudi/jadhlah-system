<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        button {
            background: #4f46e5;
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        button:hover {
            background: #4338ca;
        }
        #output {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
            border-radius: 5px;
            margin-top: 20px;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        .success { color: #4ade80; }
        .error { color: #f87171; }
        .info { color: #60a5fa; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ Ø§Ø®ØªØ¨Ø§Ø± Ù†Ø¸Ø§Ù… Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ</h1>
        
        <div>
            <label>Groom ID:</label>
            <input type="number" id="groomId" value="1105" style="padding: 8px; margin: 10px 0; width: 200px;">
        </div>
        
        <button onclick="testWithFakeData()">1ï¸âƒ£ Ø§Ø®ØªØ¨Ø§Ø± Ø¨Ø¨ÙŠØ§Ù†Ø§Øª ÙˆÙ‡Ù…ÙŠØ©</button>
        <button onclick="testWithRealSubscription()">2ï¸âƒ£ Ø§Ø®ØªØ¨Ø§Ø± Ø¨Ø§Ø´ØªØ±Ø§Ùƒ Ø­Ù‚ÙŠÙ‚ÙŠ</button>
        <button onclick="checkDatabase()">3ï¸âƒ£ ÙØ­Øµ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
        <button onclick="clearOutput()">ğŸ—‘ï¸ Ù…Ø³Ø­</button>
        
        <div id="output"></div>
    </div>

    <script>
        const output = document.getElementById('output');
        
        function log(msg, type = 'info') {
            const timestamp = new Date().toLocaleTimeString('ar-SA');
            output.innerHTML += `<span class="${type}">[${timestamp}] ${msg}</span>\n`;
            output.scrollTop = output.scrollHeight;
        }
        
        function clearOutput() {
            output.innerHTML = '';
        }
        
        async function testWithFakeData() {
            const groomId = document.getElementById('groomId').value;
            log('ğŸ§ª Ø¨Ø¯Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø¨Ø¨ÙŠØ§Ù†Ø§Øª ÙˆÙ‡Ù…ÙŠØ©...', 'info');
            
            try {
                const response = await fetch('/api/subscribe_push.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        groom_id: parseInt(groomId),
                        subscription: {
                            endpoint: 'https://test.example.com/push/test_' + Date.now(),
                            keys: {
                                auth: 'fake_auth_key_' + Date.now(),
                                p256dh: 'fake_p256dh_key_' + Date.now()
                            }
                        }
                    })
                });
                
                log('ğŸ“¡ Status: ' + response.status, 'info');
                
                const text = await response.text();
                log('ğŸ“„ Raw Response:', 'info');
                log(text, 'info');
                
                try {
                    const data = JSON.parse(text);
                    if (data.success) {
                        log('âœ… SUCCESS: ' + JSON.stringify(data, null, 2), 'success');
                    } else {
                        log('âŒ FAILED: ' + JSON.stringify(data, null, 2), 'error');
                    }
                } catch (e) {
                    log('âŒ Invalid JSON Response!', 'error');
                }
                
            } catch (error) {
                log('âŒ ERROR: ' + error.message, 'error');
            }
        }
        
        async function testWithRealSubscription() {
            const groomId = document.getElementById('groomId').value;
            log('ğŸ”” Ø¨Ø¯Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø¨Ø§Ø´ØªØ±Ø§Ùƒ Ø­Ù‚ÙŠÙ‚ÙŠ...', 'info');
            
            try {
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¯Ø¹Ù… Service Worker
                if (!('serviceWorker' in navigator)) {
                    log('âŒ Service Worker ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…', 'error');
                    return;
                }
                
                if (!('PushManager' in window)) {
                    log('âŒ Push Notifications ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…', 'error');
                    return;
                }
                
                log('âœ… Ø§Ù„Ù…ØªØµÙØ­ ÙŠØ¯Ø¹Ù… Push Notifications', 'success');
                
                // Ø·Ù„Ø¨ Ø§Ù„Ø¥Ø°Ù†
                const permission = await Notification.requestPermission();
                log('ğŸ“± Permission: ' + permission, 'info');
                
                if (permission !== 'granted') {
                    log('âŒ ØªÙ… Ø±ÙØ¶ Ø§Ù„Ø¥Ø°Ù†', 'error');
                    return;
                }
                
                // ØªØ³Ø¬ÙŠÙ„ Service Worker
                log('âš™ï¸ ØªØ³Ø¬ÙŠÙ„ Service Worker...', 'info');
                const registration = await navigator.serviceWorker.register('/sw.js');
                await navigator.serviceWorker.ready;
                log('âœ… Service Worker Ø¬Ø§Ù‡Ø²', 'success');
                
                // Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ø§Ù„Ù‚Ø¯ÙŠÙ…
                const existingSub = await registration.pushManager.getSubscription();
                if (existingSub) {
                    log('ğŸ—‘ï¸ Ø¥Ù„ØºØ§Ø¡ Ø§Ø´ØªØ±Ø§Ùƒ Ù‚Ø¯ÙŠÙ…...', 'info');
                    await existingSub.unsubscribe();
                }
                
                // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ø´ØªØ±Ø§Ùƒ Ø¬Ø¯ÙŠØ¯
                log('ğŸ“ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ø´ØªØ±Ø§Ùƒ Ø¬Ø¯ÙŠØ¯...', 'info');
                const vapidPublicKey = 'BIxYJhtuWzU00qHiGLpXE7RXbsdkapV4870OniWKAWedC1iCfxVMbiXLU7-CIngtuTM8IYcQ9j4PbVBFOiMOyhw';
                
                function urlBase64ToUint8Array(base64String) {
                    const padding = '='.repeat((4 - base64String.length % 4) % 4);
                    const base64 = (base64String + padding).replace(/\-/g, '+').replace(/_/g, '/');
                    const rawData = window.atob(base64);
                    const outputArray = new Uint8Array(rawData.length);
                    for (let i = 0; i < rawData.length; ++i) {
                        outputArray[i] = rawData.charCodeAt(i);
                    }
                    return outputArray;
                }
                
                const subscription = await registration.pushManager.subscribe({
                    userVisibleOnly: true,
                    applicationServerKey: urlBase64ToUint8Array(vapidPublicKey)
                });
                
                log('âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ', 'success');
                log('ğŸ“‹ Subscription:', 'info');
                log(JSON.stringify(subscription.toJSON(), null, 2), 'info');
                
                // Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„Ø³ÙŠØ±ÙØ±
                log('ğŸ“¤ Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„Ø³ÙŠØ±ÙØ±...', 'info');
                const response = await fetch('/api/subscribe_push.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        groom_id: parseInt(groomId),
                        subscription: subscription.toJSON()
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    log('âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­!', 'success');
                    log(JSON.stringify(data, null, 2), 'success');
                } else {
                    log('âŒ ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸: ' + JSON.stringify(data, null, 2), 'error');
                }
                
            } catch (error) {
                log('âŒ ERROR: ' + error.message, 'error');
                console.error(error);
            }
        }
        
        async function checkDatabase() {
            log('ğŸ” ÙØ­Øµ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...', 'info');
            
            try {
                // Ù‡Ù†Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ API Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                log('â„¹ï¸ Ù‚Ù… Ø¨ØªØ´ØºÙŠÙ„ Ù‡Ø°Ø§ Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù… ÙÙŠ SQL:', 'info');
                log('SELECT * FROM push_subscriptions ORDER BY created_at DESC LIMIT 5;', 'info');
                
            } catch (error) {
                log('âŒ ERROR: ' + error.message, 'error');
            }
        }
        
        log('âœ… ØµÙØ­Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø¬Ø§Ù‡Ø²Ø©', 'success');
        log('ğŸ‘† Ø§Ø®ØªØ± Ø£Ø­Ø¯ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø£Ø¹Ù„Ø§Ù‡ Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±', 'info');
    </script>
</body>
</html>